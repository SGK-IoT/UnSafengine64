name: Build UnSafengine64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025

    env:
      INSTALL_SDK: 'true'
      TARGET_SDK_VERSION: '10.0.22621.0'

    steps:
    - uses: actions/checkout@v3

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1

    - name: Detect installed Windows 10 SDK
      shell: powershell
      run: |
        Write-Host "Looking for Windows 10 SDKs in C:\Program Files (x86)\Windows Kits\10\Include"
        $sdkEntry = Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\Include' -Directory | Sort-Object Name -Descending | Select-Object -First 1
        if ($sdkEntry) {
          $sdk = $sdkEntry.Name
          Write-Host "Detected Windows SDK: $sdk"
          "WINSDK=$sdk" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        } else {
          Write-Host 'No Windows 10 SDK found under C:\Program Files (x86)\Windows Kits\10\Include'
          if ('${{ env.INSTALL_SDK }}' -eq 'true') {
            Write-Host 'INSTALL_SDK is true — attempting to download and install Windows SDK'
            Write-Host "Target SDK version: $env:TARGET_SDK_VERSION"
            # Download and run installer (example bootstrap URL — replace with official installer if desired)
            $installer = "WindowsSDKInstaller.exe"
            $url = "https://download.microsoft.com/download/9/6/6/966E0A2C-7F1F-44B3-8C5A-6F9F8E6A8B4D/WinSDKSetup.exe"
            Invoke-WebRequest -Uri $url -OutFile $installer
            Start-Process -FilePath .\$installer -ArgumentList '/quiet','/norestart' -Wait
            # Re-detect SDK
            $sdkEntry2 = Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\Include' -Directory | Sort-Object Name -Descending | Select-Object -First 1
            if ($sdkEntry2) { "WINSDK=$($sdkEntry2.Name)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append; Write-Host "Installed and detected SDK: $($sdkEntry2.Name)" }
            else { Write-Error 'SDK installation did not expose an Include folder under the expected path.'; exit 1 }
          } else {
            Write-Host 'INSTALL_SDK is false — build will attempt to run msbuild without specifying WindowsTargetPlatformVersion'
            "WINSDK=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }
        }

    - name: Extract Intel Pin
      shell: powershell
      run: |
        mkdir C:\pintool -ErrorAction SilentlyContinue
        Expand-Archive -Path pin.zip -DestinationPath C:\pintool -Force

    - name: Build (use detected SDK if present)
      shell: powershell
      run: |
        $sdk = $env:WINSDK
        if ($sdk -and $sdk.Trim().Length -gt 0) {
          Write-Host "Building using WindowsTargetPlatformVersion=$sdk"
          msbuild /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=$sdk Unsafengine64.vcxproj
          msbuild /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=$sdk Unsafengine64CUI.vcxproj
        } else {
          Write-Host 'No SDK specified - attempting build without WindowsTargetPlatformVersion'
          msbuild /p:Configuration=Release /p:Platform=x64 Unsafengine64.vcxproj
          msbuild /p:Configuration=Release /p:Platform=x64 Unsafengine64CUI.vcxproj
        }

    - name: Find and copy build outputs to pintool
      shell: powershell
      run: |
        $dll = Get-ChildItem -Recurse -Filter UnSafengine64.dll | Select-Object -First 1
        $exe = Get-ChildItem -Recurse -Filter UnSafengine64.exe | Select-Object -First 1
        if ($dll) { Copy-Item -Path $dll.FullName -Destination C:\pintool -Force; Write-Host "Copied $($dll.FullName)" }
        if ($exe) { Copy-Item -Path $exe.FullName -Destination C:\pintool -Force; Write-Host "Copied $($exe.FullName)" }

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: UnSafengine64-build
        path: C:\pintool\*

    - name: Trace Execution
      shell: powershell
      run: |
        cd C:\pintool
        .\UnSafengine64.exe -trace -log trace.log .\Skin_Injector.exe
