name: Build UnSafengine64

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025

    env:
      INSTALL_SDK: 'true'
      TARGET_SDK_VERSION: '10.0.22621.0'

    steps:
    - uses: actions/checkout@v3
      with:
        lfs: true

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1

    - name: Download Intel Pin 3.30 (MSVC Compatible)
      shell: powershell
      run: |
        Write-Host "=== Downloading Intel Pin 3.30 (MSVC Compatible) ==="
        
        $downloaded = $false
        
        Write-Host "Checking for Pin in repository (Git LFS)..."
        $repoFiles = @(
          "pin-3.30-98830-g1d7b601b3-msvc-windows.zip",
          "pin.zip"
        )
        foreach ($file in $repoFiles) {
          if (Test-Path $file) {
            $fileInfo = Get-Item $file
            if ($fileInfo.Length -gt 1MB) {
              Write-Host "[OK] Found Pin in repository: $file ($([math]::Round($fileInfo.Length/1MB, 2)) MB)"
              if ($file -ne "pin.zip") {
                Copy-Item $file "pin.zip" -Force
                Write-Host "[OK] Copied to pin.zip"
              }
              $downloaded = $true
              break
            }
          }
        }
        
        if (-not $downloaded) {
          Write-Host ""
          Write-Host "Downloading from Dropbox..."
          $dropboxUrl = "https://www.dropbox.com/scl/fi/fzdgwh8307ufcwx14zvgk/pin.zip?rlkey=ajqnxeyt26mrm6te96jq39heq&st=7msgdw6f&dl=1"
          try {
            Write-Host "Trying: $dropboxUrl"
            Invoke-WebRequest -Uri $dropboxUrl -OutFile "pin.zip" -UseBasicParsing -ErrorAction Stop
            
            if ((Test-Path "pin.zip") -and (Get-Item "pin.zip").Length -gt 1MB) {
              $downloaded = $true
              Write-Host "[OK] Downloaded from Dropbox"
            } else {
              Write-Host "[SKIP] Download failed or file too small"
              if (Test-Path "pin.zip") { Remove-Item "pin.zip" -Force }
            }
          } catch {
            Write-Host "[SKIP] Dropbox download failed: $_"
          }
        }
        
        if (-not $downloaded) {
          Write-Host ""
          Write-Host "Checking for Pin in GitHub Releases..."
          $releaseUrl = "https://github.com/${{ github.repository }}/releases/download/pin-sdk/pin-3.30-msvc-windows.zip"
          try {
            Write-Host "Trying: $releaseUrl"
            Invoke-WebRequest -Uri $releaseUrl -OutFile "pin.zip" -UseBasicParsing -ErrorAction Stop
            $downloaded = $true
            Write-Host "[OK] Downloaded from GitHub Releases"
          } catch {
            Write-Host "[SKIP] Not found in GitHub Releases"
          }
        }
        
        if ($downloaded -and (Test-Path "pin.zip")) {
          $fileInfo = Get-Item "pin.zip"
          Write-Host ""
          Write-Host "[SUCCESS] Downloaded pin.zip ($([math]::Round($fileInfo.Length/1MB, 2)) MB)"
        } else {
          Write-Host ""
          Write-Host "[ERROR] ============================================"
          Write-Host "[ERROR] Could not download Pin from any source!"
          Write-Host "[ERROR] ============================================"
          exit 1
        }

    - name: Detect installed Windows 10 SDK
      shell: powershell
      run: |
        Write-Host "Looking for Windows 10 SDKs in C:\Program Files (x86)\Windows Kits\10\Include"
        $sdkEntry = Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\Include' -Directory | Sort-Object Name -Descending | Select-Object -First 1
        if ($sdkEntry) {
          $sdk = $sdkEntry.Name
          Write-Host "Detected Windows SDK: $sdk"
          "WINSDK=$sdk" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        } else {
          Write-Host 'No Windows 10 SDK found under C:\Program Files (x86)\Windows Kits\10\Include'
          if ('${{ env.INSTALL_SDK }}' -eq 'true') {
            Write-Host 'INSTALL_SDK is true - attempting to download and install Windows SDK'
            Write-Host "Target SDK version: $env:TARGET_SDK_VERSION"
            $installer = "WindowsSDKInstaller.exe"
            $url = "https://download.microsoft.com/download/9/6/6/966E0A2C-7F1F-44B3-8C5A-6F9F8E6A8B4D/WinSDKSetup.exe"
            Invoke-WebRequest -Uri $url -OutFile $installer
            Start-Process -FilePath .\$installer -ArgumentList '/quiet','/norestart' -Wait
            $sdkEntry2 = Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\Include' -Directory | Sort-Object Name -Descending | Select-Object -First 1
            if ($sdkEntry2) { 
              "WINSDK=$($sdkEntry2.Name)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              Write-Host "Installed and detected SDK: $($sdkEntry2.Name)"
            } else {
              Write-Error 'SDK installation did not expose an Include folder under the expected path.'
              exit 1
            }
          } else {
            Write-Host 'INSTALL_SDK is false - build will attempt to run msbuild without specifying WindowsTargetPlatformVersion'
            "WINSDK=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }
        }

    - name: Extract Intel Pin
      shell: powershell
      run: |
        Write-Host "=== Extracting Intel Pin ==="
        
        if (-not (Test-Path "pin.zip")) {
          Write-Host "[ERROR] pin.zip not found in repository!"
          exit 1
        }
        
        Write-Host "[OK] Found pin.zip ($(Get-Item pin.zip | Select-Object -ExpandProperty Length) bytes)"
        Write-Host ""
        Write-Host "Extracting pin.zip..."
        $tempExtract = "C:\pin_temp"
        New-Item -ItemType Directory -Path $tempExtract -Force | Out-Null
        Expand-Archive -Path pin.zip -DestinationPath $tempExtract -Force
        
        $pinDir = Get-ChildItem $tempExtract -Directory | Where-Object {
          (Test-Path (Join-Path $_.FullName "source")) -or 
          (Test-Path (Join-Path $_.FullName "extras"))
        } | Select-Object -First 1
        
        if ($pinDir) {
          Write-Host "[OK] Found Pin SDK directory: $($pinDir.Name)"
          Move-Item -Path $pinDir.FullName -Destination "C:\pin" -Force
        } else {
          Write-Host "[WARNING] Could not find Pin SDK directory with source/extras"
          Move-Item -Path $tempExtract -Destination "C:\pin" -Force
        }
        
        New-Item -ItemType Directory -Path "C:\pintool" -Force | Out-Null
        Write-Host "Created C:\pintool for output artifacts"

    - name: Create MSVC compatibility header
      shell: powershell
      run: |
        New-Item -ItemType Directory -Path "include" -Force | Out-Null
        
        $headerContent = @"
        #ifndef MSVC_COMPAT_H
        #define MSVC_COMPAT_H
        
        #ifdef _MSC_VER
        
        #pragma warning(disable: 4530)
        #pragma warning(disable: 4577)
        #pragma warning(disable: 4091)
        
        #include <windows.h>
        #include <stddef.h>
        #include <stdint.h>
        
        #ifndef __signed__
        #define __signed__ signed
        #endif
        
        #ifndef __inline__
        #define __inline__ __inline
        #endif
        
        #ifndef __attribute__
        #define __attribute__(x)
        #endif
        
        typedef unsigned int wint_t;
        typedef int wctype_t;
        typedef int wctrans_t;
        typedef unsigned long long dev_t;
        
        #ifdef __cplusplus
        extern "C" {
        #endif
        
        int isalnum(int c);
        int isalpha(int c);
        int iscntrl(int c);
        int isdigit(int c);
        int isgraph(int c);
        int islower(int c);
        int isprint(int c);
        int ispunct(int c);
        int isspace(int c);
        int isupper(int c);
        int isxdigit(int c);
        int tolower(int c);
        int toupper(int c);
        
        wint_t btowc(int c);
        wint_t fgetwc(FILE* stream);
        wint_t fputwc(wint_t wc, FILE* stream);
        wint_t getwc(FILE* stream);
        wint_t getwchar(void);
        wint_t putwc(wint_t wc, FILE* stream);
        wint_t putwchar(wint_t wc);
        wint_t towlower(wint_t wc);
        wint_t towupper(wint_t wc);
        wint_t ungetwc(wint_t wc, FILE* stream);
        
        #ifdef __cplusplus
        }
        #endif
        
        #define _STLP_NO_WCHAR_T
        #define _STLP_NO_NATIVE_WIDE_STREAMS
        
        namespace std {
            using ::tolower;
            using ::toupper;
            using ::isalnum;
            using ::isalpha;
            using ::iscntrl;
            using ::isdigit;
            using ::isgraph;
            using ::islower;
            using ::isprint;
            using ::ispunct;
            using ::isspace;
            using ::isupper;
            using ::isxdigit;
        }
        
        #endif
        #endif
        "@
        
        $headerContent | Out-File -FilePath "include\msvc_compat.h" -Encoding ASCII
        Write-Host "Created include/msvc_compat.h"

    - name: Build projects
      shell: pwsh
      run: |
        $ErrorActionPreference = "Continue"
        $sdk = $env:WINSDK
        $logDir = "$PWD\msbuild_logs"
        New-Item -ItemType Directory -Path $logDir -Force | Out-Null
        
        if ($sdk -and $sdk.Trim().Length -gt 0) {
          Write-Host "Building using WindowsTargetPlatformVersion=$sdk"
          Write-Host "Building Unsafengine64.vcxproj..."
          msbuild /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=$sdk Unsafengine64.vcxproj "/flp:LogFile=$logDir\Unsafengine64.log;Verbosity=normal"
          if ($LASTEXITCODE -ne 0) { 
            Write-Host "ERROR: Unsafengine64.vcxproj build failed with exit code $LASTEXITCODE"
            Get-Content "$logDir\Unsafengine64.log" -ErrorAction SilentlyContinue | Select-Object -Last 50
            exit 1
          }
          
          Write-Host "Building Unsafengine64CUI.vcxproj..."
          msbuild /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=$sdk Unsafengine64CUI.vcxproj "/flp:LogFile=$logDir\Unsafengine64CUI.log;Verbosity=normal"
          if ($LASTEXITCODE -ne 0) { 
            Write-Host "ERROR: Unsafengine64CUI.vcxproj build failed with exit code $LASTEXITCODE"
            Get-Content "$logDir\Unsafengine64CUI.log" -ErrorAction SilentlyContinue | Select-Object -Last 50
            exit 1
          }
        } else {
          Write-Host "No SDK specified - attempting build without WindowsTargetPlatformVersion"
          Write-Host "Building Unsafengine64.vcxproj..."
          msbuild /p:Configuration=Release /p:Platform=x64 Unsafengine64.vcxproj "/flp:LogFile=$logDir\Unsafengine64.log;Verbosity=normal"
          if ($LASTEXITCODE -ne 0) { 
            Write-Host "ERROR: Unsafengine64.vcxproj build failed with exit code $LASTEXITCODE"
            Get-Content "$logDir\Unsafengine64.log" -ErrorAction SilentlyContinue | Select-Object -Last 50
            exit 1
          }
          
          Write-Host "Building Unsafengine64CUI.vcxproj..."
          msbuild /p:Configuration=Release /p:Platform=x64 Unsafengine64CUI.vcxproj "/flp:LogFile=$logDir\Unsafengine64CUI.log;Verbosity=normal"
          if ($LASTEXITCODE -ne 0) { 
            Write-Host "ERROR: Unsafengine64CUI.vcxproj build failed with exit code $LASTEXITCODE"
            Get-Content "$logDir\Unsafengine64CUI.log" -ErrorAction SilentlyContinue | Select-Object -Last 50
            exit 1
          }
        }
        
        Write-Host "Build completed successfully!"

    - name: Show MSBuild logs
      if: failure()
      shell: powershell
      run: |
        Write-Host "=== MSBuild logs ==="
        Get-ChildItem -Path msbuild_logs -File | ForEach-Object { 
          Write-Host "--- $($_.Name) ---"
          Get-Content $_.FullName -TotalCount 200 
        }

    - name: Find and copy build outputs
      shell: powershell
      run: |
        Write-Host "=== Searching for build outputs ==="
        
        $patterns = @('UnSafengine64.exe','UnSafengine64.dll','UnSafengine64CUI.exe')
        foreach ($p in $patterns) {
          $found = Get-ChildItem -Path $PWD -Recurse -Filter $p -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($found) { 
            Copy-Item -Path $found.FullName -Destination C:\pintool -Force
            Write-Host "[OK] Copied $($found.FullName) to C:\pintool"
          } else { 
            Write-Host "[MISSING] Not found: $p" 
          }
        }
        
        Write-Host ""
        Write-Host "=== Contents of C:\pintool ==="
        Get-ChildItem -Path C:\pintool -Recurse | Select-Object FullName, Length | Format-Table

    - name: Verify build outputs
      shell: powershell
      run: |
        $exe = Get-ChildItem -Path C:\pintool -Filter UnSafengine64.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $exe) { 
          Write-Error 'UnSafengine64.exe not found in C:\pintool - build probably failed'
          exit 1 
        }
        Write-Host "Found executable: $($exe.FullName)"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: UnSafengine64-build-${{ github.sha }}
        path: C:\pintool\*

    - name: Trace Execution (if Skin_Injector.exe exists)
      if: success()
      shell: powershell
      run: |
        cd C:\pintool
        if (Test-Path ".\Skin_Injector.exe") {
          Write-Host "Running: .\UnSafengine64.exe -trace -log trace.log .\Skin_Injector.exe"
          .\UnSafengine64.exe -trace -log trace.log .\Skin_Injector.exe
        } else {
          Write-Host "Skin_Injector.exe not found, skipping trace execution"
        }
