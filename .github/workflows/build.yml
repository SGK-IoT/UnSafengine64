name: Build UnSafengine64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
    - name: Detect installed Windows 10 SDK
      run: |
        $sdk = (Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\Include' -Directory | Sort-Object Name -Descending | Select-Object -First 1).Name
        if (-not $sdk) { Write-Error 'No Windows 10 SDK found in C:\Program Files (x86)\Windows Kits\10\Include'; exit 1 }
        Write-Host "Detected Windows SDK: $sdk"
        "WINSDK=$sdk" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: powershell

    - name: Extract Intel Pin
      run: |
        mkdir C:\pintool
        Expand-Archive -Path pin.zip -DestinationPath C:\pintool
        # (rest of extract steps...)
      shell: powershell

    - name: Build DLL
      run: |
        msbuild /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=$env:WINSDK Unsafengine64.vcxproj
        Get-ChildItem -Recurse | Where-Object {$_.Name -like "UnSafengine64.dll"}
      shell: powershell

    - name: Build CUI
      run: |
        msbuild /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=$env:WINSDK Unsafengine64CUI.vcxproj
        Get-ChildItem -Recurse | Where-Object {$_.Name -like "UnSafengine64.exe"}
      shell: powershell

    - name: List Files
      run: |
        Get-ChildItem -Recurse C:\pintool | Select-Object FullName, Length
      shell: powershell

    - name: Copy artifacts to pintool
      run: |
        Copy-Item -Path "$(Get-ChildItem -Recurse | Where-Object {$_.Name -like 'UnSafengine64.dll'} | Select-Object -First 1).FullName" -Destination C:\pintool -Force
        Copy-Item -Path "$(Get-ChildItem -Recurse | Where-Object {$_.Name -like 'UnSafengine64.exe'} | Select-Object -First 1).FullName" -Destination C:\pintool -Force
      shell: powershell

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: UnSafengine64-build
        path: C:\pintool\*
        
    - name: Trace Execution
      run: |
        cd C:\pintool
        .\UnSafengine64.exe -trace -log trace.log .\Skin_Injector.exe
      shell: powershell
