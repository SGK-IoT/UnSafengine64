name: Build UnSafengine64

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025

    env:
      INSTALL_SDK: 'true'
      TARGET_SDK_VERSION: '10.0.22621.0'

    steps:
    - uses: actions/checkout@v3

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1

    - name: Detect installed Windows 10 SDK
      shell: powershell
      run: |
        Write-Host "Looking for Windows 10 SDKs in C:\Program Files (x86)\Windows Kits\10\Include"
        $sdkEntry = Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\Include' -Directory | Sort-Object Name -Descending | Select-Object -First 1
        if ($sdkEntry) {
          $sdk = $sdkEntry.Name
          Write-Host "Detected Windows SDK: $sdk"
          "WINSDK=$sdk" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        } else {
          Write-Host 'No Windows 10 SDK found under C:\Program Files (x86)\Windows Kits\10\Include'
          if ('${{ env.INSTALL_SDK }}' -eq 'true') {
            Write-Host 'INSTALL_SDK is true — attempting to download and install Windows SDK'
            Write-Host "Target SDK version: $env:TARGET_SDK_VERSION"
            $installer = "WindowsSDKInstaller.exe"
            $url = "https://download.microsoft.com/download/9/6/6/966E0A2C-7F1F-44B3-8C5A-6F9F8E6A8B4D/WinSDKSetup.exe"
            Invoke-WebRequest -Uri $url -OutFile $installer
            Start-Process -FilePath .\$installer -ArgumentList '/quiet','/norestart' -Wait
            $sdkEntry2 = Get-ChildItem 'C:\Program Files (x86)\Windows Kits\10\Include' -Directory | Sort-Object Name -Descending | Select-Object -First 1
            if ($sdkEntry2) { "WINSDK=$($sdkEntry2.Name)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append; Write-Host "Installed and detected SDK: $($sdkEntry2.Name)" }
            else { Write-Error 'SDK installation did not expose an Include folder under the expected path.'; exit 1 }
          } else {
            Write-Host 'INSTALL_SDK is false — build will attempt to run msbuild without specifying WindowsTargetPlatformVersion'
            "WINSDK=" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }
        }

    - name: Extract Intel Pin
      shell: powershell
      run: |
        Write-Host "Extracting pin.zip..."
        $tempExtract = "C:\pin_temp"
        New-Item -ItemType Directory -Path $tempExtract -Force | Out-Null
        Expand-Archive -Path pin.zip -DestinationPath $tempExtract -Force
        
        # Check if extraction created a subdirectory (common with archives)
        $subDirs = Get-ChildItem $tempExtract -Directory
        if ($subDirs.Count -eq 1) {
          Write-Host "Pin extracted to subdirectory: $($subDirs[0].Name)"
          Write-Host "Moving contents from $($subDirs[0].FullName) to C:\pin"
          Move-Item -Path $subDirs[0].FullName -Destination "C:\pin" -Force
        } else {
          Write-Host "Pin extracted to temp directory, moving to C:\pin"
          Move-Item -Path $tempExtract -Destination "C:\pin" -Force
        }
        
        Write-Host ""
        Write-Host "Verifying Pin extraction..."
        if (Test-Path "C:\pin\source\include\pin") {
          Write-Host "SUCCESS: Pin headers found at C:\pin\source\include\pin"
        } else {
          Write-Host "WARNING: Pin headers not found at expected location"
          Write-Host "Contents of C:\pin:"
          Get-ChildItem C:\pin -Recurse -Depth 2 | Select-Object FullName | Format-List
        }
        
        # Create output directory for final artifacts
        New-Item -ItemType Directory -Path "C:\pintool" -Force | Out-Null
        Write-Host ""
        Write-Host "Created C:\pintool for output artifacts"

    - name: Create missing include files
      shell: powershell
      run: |
        # Create include directory if it doesn't exist
        New-Item -ItemType Directory -Path "include" -Force | Out-Null
        
        # Create msvc_compat.h with basic compatibility definitions
        @"
        #ifndef MSVC_COMPAT_H
        #define MSVC_COMPAT_H
        
        // MSVC compatibility header for PIN tools
        // Add any necessary compatibility definitions here
        
        #endif // MSVC_COMPAT_H
        "@ | Out-File -FilePath "include\msvc_compat.h" -Encoding ASCII
        
        Write-Host "Created include/msvc_compat.h"
        
        # Verify the file was created
        if (Test-Path "include\msvc_compat.h") {
          Write-Host "Verified: include\msvc_compat.h exists"
          Get-Content "include\msvc_compat.h" | Write-Host
        } else {
          Write-Error "Failed to create include\msvc_compat.h"
          exit 1
        }
        
        # Show current directory and structure
        Write-Host "Current directory: $PWD"
        Write-Host "Directory structure:"
        Get-ChildItem -Recurse -Depth 2 | Select-Object FullName

    - name: Build projects
      shell: pwsh
      run: |
        $ErrorActionPreference = "Continue"
        $sdk = $env:WINSDK
        $logDir = "$PWD\msbuild_logs"
        New-Item -ItemType Directory -Path $logDir -Force | Out-Null
        
        if ($sdk -and $sdk.Trim().Length -gt 0) {
          Write-Host "Building using WindowsTargetPlatformVersion=$sdk"
          Write-Host "Building Unsafengine64.vcxproj..."
          msbuild /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=$sdk Unsafengine64.vcxproj "/flp:LogFile=$logDir\Unsafengine64.log;Verbosity=normal"
          if ($LASTEXITCODE -ne 0) { 
            Write-Host "ERROR: Unsafengine64.vcxproj build failed with exit code $LASTEXITCODE"
            Get-Content "$logDir\Unsafengine64.log" -ErrorAction SilentlyContinue | Select-Object -Last 50
            exit 1
          }
          
          Write-Host "Building Unsafengine64CUI.vcxproj..."
          msbuild /p:Configuration=Release /p:Platform=x64 /p:WindowsTargetPlatformVersion=$sdk Unsafengine64CUI.vcxproj "/flp:LogFile=$logDir\Unsafengine64CUI.log;Verbosity=normal"
          if ($LASTEXITCODE -ne 0) { 
            Write-Host "ERROR: Unsafengine64CUI.vcxproj build failed with exit code $LASTEXITCODE"
            Get-Content "$logDir\Unsafengine64CUI.log" -ErrorAction SilentlyContinue | Select-Object -Last 50
            exit 1
          }
        } else {
          Write-Host "No SDK specified - attempting build without WindowsTargetPlatformVersion"
          Write-Host "Building Unsafengine64.vcxproj..."
          msbuild /p:Configuration=Release /p:Platform=x64 Unsafengine64.vcxproj "/flp:LogFile=$logDir\Unsafengine64.log;Verbosity=normal"
          if ($LASTEXITCODE -ne 0) { 
            Write-Host "ERROR: Unsafengine64.vcxproj build failed with exit code $LASTEXITCODE"
            Get-Content "$logDir\Unsafengine64.log" -ErrorAction SilentlyContinue | Select-Object -Last 50
            exit 1
          }
          
          Write-Host "Building Unsafengine64CUI.vcxproj..."
          msbuild /p:Configuration=Release /p:Platform=x64 Unsafengine64CUI.vcxproj "/flp:LogFile=$logDir\Unsafengine64CUI.log;Verbosity=normal"
          if ($LASTEXITCODE -ne 0) { 
            Write-Host "ERROR: Unsafengine64CUI.vcxproj build failed with exit code $LASTEXITCODE"
            Get-Content "$logDir\Unsafengine64CUI.log" -ErrorAction SilentlyContinue | Select-Object -Last 50
            exit 1
          }
        }
        
        Write-Host "Build completed successfully!"

    - name: Show MSBuild logs
      shell: powershell
      run: |
        Write-Host "=== MSBuild logs ==="
        Get-ChildItem -Path msbuild_logs -File | ForEach-Object { Write-Host "--- $_.Name ---"; Get-Content $_.FullName -TotalCount 200 }

    - name: Find and copy build outputs to pintool (robust)
      shell: powershell
      run: |
        Write-Host "=== Searching for build outputs ==="
        Write-Host "Current directory: $PWD"
        
        # Show what was built
        Write-Host ""
        Write-Host "Searching in x64\Release directory:"
        if (Test-Path "x64\Release") {
          Get-ChildItem "x64\Release" -Recurse | Select-Object FullName, Length | Format-Table
        } else {
          Write-Host "x64\Release directory not found!"
        }
        
        Write-Host ""
        Write-Host "Searching for build outputs recursively..."
        $patterns = @('UnSafengine64.exe','UnSafengine64.dll','UnSafengine64CUI.exe')
        foreach ($p in $patterns) {
          $found = Get-ChildItem -Path $PWD -Recurse -Filter $p -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($found) { 
            Copy-Item -Path $found.FullName -Destination C:\pintool -Force
            Write-Host "[OK] Copied $($found.FullName) to C:\pintool"
          } else { 
            Write-Host "[MISSING] Not found: $p" 
          }
        }
        
        Write-Host ""
        Write-Host "=== Contents of C:\pintool ==="
        Get-ChildItem -Path C:\pintool -Recurse | Select-Object FullName, Length | Format-Table

    - name: Ensure UnSafengine64.exe exists before trace
      shell: powershell
      run: |
        $exe = Get-ChildItem -Path C:\pintool -Filter UnSafengine64.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $exe) { Write-Error 'UnSafengine64.exe not found in C:\pintool — build probably failed or output placed elsewhere. See msbuild logs above.'; exit 1 }
        else { Write-Host "Found executable: $($exe.FullName)" }

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: UnSafengine64-build
        path: C:\pintool\*

    - name: Trace Execution
      shell: powershell
      run: |
        cd C:\pintool
        Write-Host "Running: .\UnSafengine64.exe -trace -log trace.log .\Skin_Injector.exe"
        .\UnSafengine64.exe -trace -log trace.log .\Skin_Injector.exe
